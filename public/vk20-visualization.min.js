!function(t){"function"==typeof define&&define.amd?define(t):t()}(function(){"use strict";function H(n,s){var o=Date.now(),a=60,r=1e3/60,h=0,l=!0;return window.requestAnimationFrame(function t(){if(l){var e=Date.now();if(e<o+1e3/a)window.requestAnimationFrame(t);else{r*a<(h+=e-o)&&(h=r*a),o=e;for(var i=0;r<=h;)if(n(r),h-=r,240<=++i){h=0;break}s(),window.requestAnimationFrame(t)}}}),function(){l=!1}}function N(t,e,i){return t*(1-i)+e*i}var r=Math.sqrt(3)/2;function v(t,e,i,n,s){var o=4<arguments.length&&void 0!==s?s:0,a=e*r;t.save(),t.translate(i,n),t.rotate(.0174533*o),t.beginPath(),t.moveTo(0,-a/2),t.lineTo(-e/2,a/2),t.lineTo(e/2,a/2),t.lineTo(0,-a/2),t.stroke(),t.closePath(),t.restore()}var F=100,S=10,u=.4,W=1.2;function Y(t,e,i,n){this.max_objects=e||10,this.max_levels=i||4,this.level=n||0,this.bounds=t,this.objects=[],this.nodes=[]}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function t(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}Y.prototype.split=function(){var t=this.level+1,e=this.bounds.width/2,i=this.bounds.height/2,n=this.bounds.x,s=this.bounds.y;this.nodes[0]=new Y({x:n+e,y:s,width:e,height:i},this.max_objects,this.max_levels,t),this.nodes[1]=new Y({x:n,y:s,width:e,height:i},this.max_objects,this.max_levels,t),this.nodes[2]=new Y({x:n,y:s+i,width:e,height:i},this.max_objects,this.max_levels,t),this.nodes[3]=new Y({x:n+e,y:s+i,width:e,height:i},this.max_objects,this.max_levels,t)},Y.prototype.getIndex=function(t){var e=[],i=this.bounds.x+this.bounds.width/2,n=this.bounds.y+this.bounds.height/2,s=t.y<n,o=t.x<i,a=t.x+t.width>i,r=t.y+t.height>n;return s&&a&&e.push(0),o&&s&&e.push(1),o&&r&&e.push(2),a&&r&&e.push(3),e},Y.prototype.insert=function(t){var e,i=0;if(this.nodes.length)for(e=this.getIndex(t),i=0;i<e.length;i++)this.nodes[e[i]].insert(t);else if(this.objects.push(t),this.objects.length>this.max_objects&&this.level<this.max_levels){for(this.nodes.length||this.split(),i=0;i<this.objects.length;i++){e=this.getIndex(this.objects[i]);for(var n=0;n<e.length;n++)this.nodes[e[n]].insert(this.objects[i])}this.objects=[]}},Y.prototype.retrieve=function(t){var e=this.getIndex(t),i=this.objects;if(this.nodes.length)for(var n=0;n<e.length;n++)i=i.concat(this.nodes[e[n]].retrieve(t));return i=i.filter(function(t,e){return i.indexOf(t)>=e})},Y.prototype.clear=function(){this.objects=[];for(var t=0;t<this.nodes.length;t++)this.nodes.length&&this.nodes[t].clear();this.nodes=[]};var B=function(){function n(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;o(this,n),this.x=t,this.y=e}return t(n,[{key:"add",value:function(t){this.x+=t.x,this.y+=t.y}},{key:"sub",value:function(t){this.x-=t.x,this.y-=t.y}},{key:"mult",value:function(t){this.x*=t,this.y*=t}},{key:"div",value:function(t){this.x/=t,this.y/=t}},{key:"lerp",value:function(t,e){this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e}},{key:"dist",value:function(t){return new n(this.x-t.x,this.y-t.y).length}},{key:"setMag",value:function(t){0!==this.length&&this.mult(t/this.length)}},{key:"rotate",value:function(t){var e=this.heading,i=n.fromAngle(t+e);i.mult(this.length),this.x=i.x,this.y=i.y}},{key:"toJSObject",value:function(){var t={};return t.x=this.x,t.y=this.y,t}},{key:"copy",get:function(){return new n(this.x,this.y)}},{key:"length",get:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"sqlength",get:function(){return this.x*this.x+this.y*this.y}},{key:"heading",get:function(){if(0===this.x&&0===this.y)return 0;if(0===this.x)return 0<this.y?Math.PI/2:1.5*Math.PI;if(0===this.y)return 0<this.x?0:Math.PI;var t=n.normalized(this);return 0<this.x&&0<this.y?Math.asin(t.y):this.x<0&&0<this.y?Math.asin(-t.x)+Math.PI/2:this.x<0&&this.y<0?Math.asin(-t.y)+Math.PI:0<this.x&&this.y<0?Math.asin(t.x)+1.5*Math.PI:0}}],[{key:"add",value:function(t,e,i){return(i=i||new n).x=t.x+e.x,i.y=t.y+e.y,i}},{key:"sub",value:function(t,e,i){return(i=i||new n).x=t.x-e.x,i.y=t.y-e.y,i}},{key:"mult",value:function(t,e,i){return(i=i||new n).x=t.x*e,i.y=t.y*e,i}},{key:"div",value:function(t,e,i){return(i=i||new n).x=t.x/e,i.y=t.y/e,i}},{key:"fromAngle",value:function(t){return new n(Math.cos(t),Math.sin(t))}},{key:"lerp",value:function(t,e,i){return n.add(t,n.mult(n.sub(e,t),i))}},{key:"dist",value:function(t,e){return n.sub(t,e).length}},{key:"dot",value:function(t,e){return t.x*e.x+t.y*e.y}},{key:"cross",value:function(t,e){return t.x*e.y-t.y*e.x}},{key:"angle",value:function(t,e){return Math.acos(n.dot(t,e)/Math.sqrt(t.sqlength*e.sqlength))}},{key:"angleACW",value:function(t,e){var i=t.heading,n=e.heading-i;return n<0?2*Math.PI+n:n}},{key:"normalized",value:function(t){var e=t.length;return 0===e?t:new n(t.x/e,t.y/e)}},{key:"fromObject",value:function(t){return new n(t.x,t.y)}}]),n}();B.cached=[new B,new B,new B,new B,new B,new B,new B,new B,new B,new B];var L=function(){function s(t,e,i,n){o(this,s),this.state=0,this.position=new B,this.prevPosition=this.position.copy,this.velocity=new B,this.opinions=t,this.clusterId=e,this.radius=5*i,this.scale=i,this.k=.5,this.velocities=[],this.cluster=n,this.randomClusterOffset(),this.isAtRest=!1,this.secondsAtRest=0,this.sleepCounter=0,this.opacity=0,this.targetOpacity=0}return t(s,[{key:"randomClusterOffset",value:function(){var t=2*this.cluster.radius,e=this.cluster.radius;this.clusterOffset=new B(-t/2+Math.random()*t,-e/2+Math.random()*e)}},{key:"isNormal",value:function(){return 0===this.state}},{key:"update",value:function(t,e){t.clusters[this.clusterId];var i=this.velocity.length;this.velocities.push(i),10<this.velocities.length&&this.velocities.splice(0,this.velocities.length-10),this.activityLevel=this.velocities.reduce(function(t,e){return t+e},0)/this.velocities.length,this.activityLevel<.01?this.secondsAtRest+=e/1e3:this.secondsAtRest=0,this.isAtRest=2<this.secondsAtRest;switch(i<.005?this.sleepCounter<5&&this.sleepCounter++:0<this.sleepCounter&&this.sleepCounter--,this.opacity=N(this.opacity,this.targetOpacity,.1),this.isSleeping=5==this.sleepCounter,this.prevPosition=this.position.copy,1e-4<this.velocity.sqlength&&this.velocity.setMag(.01),this.isSleeping||this.position.add(B.mult(this.velocity,e,B.cached[0])),this.velocity.mult(.8),this.state){case 0:this.updateNormal(t,e);break;case 1:this.updateBeingElected(t,e);break;case 2:this.updateElected(t,e)}}},{key:"updateNormal",value:function(t,e){var i=t.clusters[this.clusterId],n=B.sub(B.add(this.position,this.clusterOffset,B.cached[0]),new B(i.x,i.y),B.cached[0]),s=n.length;this.velocity.sub(new B(15e-7*n.x*(s>i.radius?1:s/i.radius)*e,15e-7*n.y*(s>i.radius?1:s/i.radius)*e)),this.mass=1+s,Math.random()<5e-5&&this.randomClusterOffset()}},{key:"updateBeingElected",value:function(t,e){this.electionTimer+=e/1e3;var i=t.clusters[this.clusterId];.5<=this.electionTimer&&(this.state=2,i.beingElectedCount--)}},{key:"updateElected",value:function(t,e){t.parliament;var i=B.sub(this.seat,this.position),n=i.length;this.mass=n<5?1:1e4,3<n&&(i.setMag(1),i.mult(.1*e/1e3),this.velocity.add(i))}}],[{key:"getElectedFullRadius",value:function(){return 10}},{key:"collide",value:function(t,e){var i=t.radius+e.radius+5*t.scale;if(!(Math.abs(t.position.x-e.position.x)>i&&Math.abs(t.position.y-e.position.y)>i)){var n=B.sub(t.position,e.position,B.cached[0]),s=n.sqlength;if(i*i<s)return!1;var o=t.mass,a=e.mass,r=1/t.mass,h=1/e.mass,l=(t.k+e.k)/2,u=i-Math.sqrt(s);n.setMag(1),n.mult(u*a/(o+a)),t.position.add(n),n.setMag(1),n.mult(-u*o/(o+a)),e.position.add(n);var c=B.dot(n,B.sub(t.velocity,e.velocity,B.cached[1]));if(!(c<0)){n.setMag(1);var d=-(1+l)*c/(r+h),v=B.mult(n,d,B.cached[2]);t.velocity.add(B.mult(v,r,B.cached[3])),e.velocity.sub(B.mult(v,h,B.cached[4]))}}}}]),s}();function X(t,e){for(var i=[],n=[],s=0;s<e;s++)i.push(s),n.push(0);!function(t){for(var e,i,n=t.length;0!==n;)i=Math.floor(Math.random()*n),e=t[--n],t[n]=t[i],t[i]=e}(i);var o=[],a=1,r=Math.max(u,a/e);for(s=0;s<e;s++){var h=a*Math.random();r<h&&(h=r),a-=h,n[i[s]]=h}for(s=0;s<e;s++){var l=n[s];o.push(t.slice(0,Math.round(t.length*l)))}return o}function m(n,t,e,i,s){for(var o=4<arguments.length&&void 0!==s?s:1,a=n.getContext("2d"),r=[],h=[],l=0;l<F;l++){for(var u=[],c=0;c<5;c++)u.push(2*Math.random()-1);h.push(u)}var d={position:new B(e/2,i/2),radius:80*o};if(t){var v=t.getBoundingClientRect();d.position.x=v.x+v.width/2,d.position.y=window.scrollY+v.y+v.height/2+d.radius}var f=[],y=7+Math.round(5*Math.random()),g=e,m=new B(e/2,d.position.y/2+g);if(t){var p=t.getBoundingClientRect();m.y=(window.scrollY+p.y)/2+g}var x=X(h,y),M=-180,w=0;if(e<2*g){var b=new B(0,m.y-Math.sqrt(g*g-Math.pow(+m.x,2))),T=new B(e,m.y-Math.sqrt(g*g-Math.pow(m.x-e,2))),k=B.sub(m,b),I=B.sub(m,T);M=57.2958*k.heading-180,w=57.2958*I.heading-180}var P=(w-M)/(y+1),C=0;for(l=0;l<x.length;l++){var E=Math.PI*Math.pow(5+5*o,2),j={opinions:x[l],citizenCount:x[l].length,representativeCount:0,beingElectedCount:0,timeSinceElection:0,restCount:0,representativeMaxCount:Math.round(x[l].length/S),x:m.x+Math.cos((M+(P+l*P))*Math.PI/180)*g+(-e/2+Math.random()*e),y:m.y+Math.sin((M+(P+l*P))*Math.PI/180)*g+(-i/2+Math.random()*i),finalX:m.x+Math.cos((M+(P+l*P))*Math.PI/180)*g,finalY:m.y+Math.sin((M+(P+l*P))*Math.PI/180)*g,radius:Math.sqrt(E*x[l].length*.9069)/Math.PI*2};j.x=e*Math.random(),j.y=i*Math.random(),j.finalX=e*Math.random(),j.finalY=i*Math.random(),C+=j.representativeMaxCount,f.push(j)}C<x.length&&(f[f.length-1].representativeMaxCount+=x.length-C);for(l=0;l<f.length;l++){var O=f[l];for(c=0;c<O.opinions.length;c++){var q=new L(O.opinions[c],l,o,O);q.position.x=-e+Math.random()*(3*e),q.position.y=Math.random()*i,q.index=r.length,r.push(q)}}var A={citizens:r,clusters:f,parliament:d,clusterPositionRadius:g,clusterCircleCenter:m,width:e,height:i};A.parliament.seats=function(t){var r=t.parliament,e=L.getElectedFullRadius(),i=Math.round(F/S),n=[],s=0,o=0,a=r.radius;for(;!(10<s);){var h=-170,l=-10-h,u=2*e*W/(Math.PI*a)*180,c=Math.round(l/u),d=l/c;if(i<o+c){var v=i-(o+c);h-=Math.round(v/2)*d}for(var f=0;f<c+1&&!(i<o);f++){o++;var y=h+f*d,g=a*Math.cos(y*Math.PI/180),m=a*Math.sin(y*Math.PI/180);n.push(new B(r.position.x+g,r.position.y+m))}if(i<o)break;s++,a+=2*e*W}return n.sort(function(t,e){var i=B.sub(t,r.position),n=i.length;i.setMag(1);var s=57.2958*i.heading,o=(i=B.sub(e,r.position)).length;i.setMag(1);var a=s-57.2958*i.heading;return Math.abs(a)<10?n-o:a}),n}(A);var z=0;for(l=0;l<f.length;l++){var R=f[l];R.seats=A.parliament.seats.slice(z,z+R.representativeMaxCount),z+=R.representativeMaxCount}var _=H(function(t){return function(t,e){for(var i=t.citizens,n=t.clusters,s=t.width,o=t.height,a=new Y({x:-s,y:-o,width:3*s,height:3*o},20,10),r=0;r<i.length;r++){var h=i[r];n[h.clusterId];h.closeToOthers=0,h.update(t,e),a.insert({x:h.position.x-h.radius,y:h.position.y-h.radius,width:2*h.radius,height:2*h.radius,citizen:h})}for(r=0;r<n.length;r++)n[r].restCount=0,n[r].timeSinceElection+=e/1e3,n[r].x=N(n[r].x,n[r].finalX,7e-4),n[r].y=N(n[r].y,n[r].finalY,7e-4);for(r=0;r<i.length;r++){for(var l=i[r],u=a.retrieve({x:l.position.x-2*l.radius,y:l.position.y-2*l.radius,width:4*l.radius,height:4*l.radius}),c=0;c<u.length;c++){var d=u[c].citizen;d!=l&&d.index>r&&L.collide(l,d),d.clusterId==l.clusterId&&(l.closeToOthers++,d.closeToOthers++)}l.isAtRest&&l.isNormal()&&n[l.clusterId].restCount++,l.targetOpacity=Math.min(l.closeToOthers,50)/50}}(A,t)},function(){return t=n,g=a,i=(e=A).citizens,e.clusters,e.parliament,e.clusterPositionRadius,e.clusterCircleCenter,m=e.width,p=e.height,g.clearRect(0,0,t.width,t.height),g.lineWidth=2,void i.forEach(function(t){var e,i,n,s,o,a,r,h,l,u,c=t.position,d=t.clusterId,v=t.radius,f=(t.col,i=e=0,n=m,s=p,o=c.x,a=c.y,r=o-=e,h=n-o,l=a-=i,u=s-a,Math.min(u,Math.min(h,Math.min(l,r))));if(f<0&&(f=0),t.isNormal()){var y=function(t,e){if(!D[t]){var i=document.createElement("canvas");i.width=3*e,i.height=3*e;var n=i.getContext("2d");n.lineWidth=2,V(t,e,n,3*e/2),D[t]=i}return D[t]}(d,v);g.save(),g.drawImage(y,c.x-y.width/2,c.y-y.height/2),g.restore()}else g.save(),g.translate(c.x,c.y),V(d,v,g,0),g.restore()});var t,g,e,i,m,p});return function(){_()}}var D={};function V(t,e,i,n){switch(i.beginPath(),t+1e3){case 1:var s=e;i.save(),i.translate(n,n),i.moveTo(-s,-s),i.lineTo(-s,+s),i.lineTo(+s,+s),i.lineTo(+s,-s),i.lineTo(-s,-s),i.lineTo(-s,+s),i.restore();break;case 2:v(i,2.5*e,n,n);break;case 3:var o=e+2,a=o/3;i.save(),i.translate(n,n),i.rotate(45*.0174533),i.moveTo(-o,+a),i.lineTo(-o,-a),i.lineTo(-a,-a),i.lineTo(-a,-o),i.lineTo(+a,-o),i.lineTo(+a,-a),i.lineTo(+o,-a),i.lineTo(+o,+a),i.lineTo(+a,+a),i.lineTo(+a,+o),i.lineTo(-a,+o),i.lineTo(-a,+a),i.lineTo(-o,+a),i.lineTo(-o,-a),i.restore();break;case 4:i.beginPath();for(var r=0;r<2*Math.PI;r+=2*Math.PI/5){var h=n+Math.cos(r-90*Math.PI/180)*e*1.3,l=n+Math.sin(r-90*Math.PI/180)*e*1.3;0==r?i.moveTo(h,l):i.lineTo(h,l)}i.closePath();break;case 5:var u=e;i.save(),i.translate(n,n),i.rotate(45*.0174533),i.moveTo(-u,-u),i.lineTo(-u,+u),i.lineTo(+u,+u),i.lineTo(+u,-u),i.lineTo(-u,-u),i.lineTo(-u,+u),i.restore();break;case 6:var c=e+2,d=c/3;i.save(),i.translate(n,n),i.moveTo(-c,+d),i.lineTo(-c,-d),i.lineTo(-d,-d),i.lineTo(-d,-c),i.lineTo(+d,-c),i.lineTo(+d,-d),i.lineTo(+c,-d),i.lineTo(+c,+d),i.lineTo(+d,+d),i.lineTo(+d,+c),i.lineTo(-d,+c),i.lineTo(-d,+d),i.lineTo(-c,+d),i.lineTo(-c,-d),i.restore();break;case 7:v(i,2.5*e,n,n,180);break;default:i.arc(n,n,e,0,2*Math.PI)}i.fill()}window.initParliamentVisualization=function(t){var e=t.centerElement,i=t.zIndex,n=void 0===i?0:i,s=t.height,o=void 0===s?null:s,a=t.scale,r=void 0===a?1:a;if(!e)throw new Error("[initParliamentVisualization] Invalid argument centerElement: ".concat(e));var h=document.createElement("canvas");document.body.prepend(h),h.style="\n    pointer-events: none; \n    margin: 0; \n    padding: 0; \n    width: 100%; \n    position: absolute;\n    z-index: ".concat(n,"; \n    opacity: ").concat(1,";\n    ");var l=!0;g();var u=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),c=function(){return m(h,e,window.innerWidth,o||u,r)},d=c(),v=null,f=0,y=0;function g(){u=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight);var t=window.innerWidth,e=o||u;t==f&&e==y||(h.setAttribute("width",t),h.setAttribute("height",e),f=t,y=e,l||(v&&clearTimeout(v),v=setTimeout(function(){d(),d=c()},200)),l=!1)}return window.addEventListener("resize",g),{canvas:h,destroy:function(){d(),h.parentNode.removeChild(h),window.removeEventListener("resize",g)}}}});
